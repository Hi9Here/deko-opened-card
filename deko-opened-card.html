<link rel="import" href="../quill-js/quill-js.html">
<!--
  `deko-opened-card`
  @demo demo/index.html
-->

<dom-module id="deko-opened-card">
  <template>
    <style>
      :host {display:block}
    </style>
    <img src="[[image]]" style="max-width:100%" />
    <quill-js show value="[[quill]]" theme="bubble"></quill-js>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-opened-card",
    properties:{
      _getData: {
        computed:"setValues(ref)",
      },
    },
    setValues: function(ref){
      var that = this
      if (this.unsub) {
        this.unsub()
      }
      if (ref) {
        this.unsub = ref.onSnapshot(function(doc) {
          if (doc && doc.exists) {
            if (that.unsubImage) {
              that.unsubImage()
            }
            that.unsubImage = ref.collection("big image").orderBy("time", "desc").limit(1).onSnapshot(function(image) {
              if (image && image.size) {
                that.set("image", image.docs[0].data().value)
              } else {
                that.set("image", "")
              }
              if (!image.exists){
                that.unsubImage()
              }
            })
            
            if (that.unsubQuill) {
              that.unsubQuill()
            }
            that.unsubQuill = ref.collection("quill").orderBy("time", "desc").limit(1).onSnapshot(function(quill) {
              if (quill && quill.size) {
                that.set("quill", quill.docs[0].data().value)
              } else {
                that.set("quill", "")
              }
              if (!quill.exists){
                that.unsubQuill()
              }
            })
            
            that.set( "title", doc.data().title)
            // that.set( "description", doc.data().description)
          } else if (!doc.exists) {
            that.unsub()
            that.unsubQuill()
            that.unsubImage()
          }
        })
      } 
    },
  })
</script>
